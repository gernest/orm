// Autogenerated by github.com/posener/orm
package allorm

import (
	"log"

	"github.com/posener/orm/example"
)

// String returns the SQL query string
func (s *Select) String() string {
	return "SELECT " + s.selectString() + " FROM all " + s.where.String()
}

// Exec runs the Query on a given database.
func (s *Select) Exec(db SQLQuerier) ([]example.All, error) {
	// create select statement
	stmt := s.String()
	args := s.where.Args()
	log.Printf("Query: '%v' %v", stmt, args)
	rows, err := db.Query(stmt, args...)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	// extract rows to structures
	var all []example.All
	for rows.Next() {
		var i example.All
		if err := rows.Scan(s.scanArgs(&i)...); err != nil {
			return nil, err
		}
		all = append(all, i)
	}
	return all, rows.Err()
}

// SelectInt Add Int to the selected column of a query
func (s *Select) SelectInt() *Select {
	s.columns = append(s.columns, "int")
	return s
}

// SelectText Add Text to the selected column of a query
func (s *Select) SelectText() *Select {
	s.columns = append(s.columns, "text")
	return s
}

// SelectBool Add Bool to the selected column of a query
func (s *Select) SelectBool() *Select {
	s.columns = append(s.columns, "bool")
	return s
}

// scanArgs are list of fields to be given to the sql Scan command
func (s *Select) scanArgs(p *example.All) []interface{} {
	if len(s.columns) == 0 {
		// add to args all the fields of p
		return []interface{}{
			&p.Int,
			&p.Text,
			&p.Bool,
		}
	}
	m := s.columnsMap()
	args := make([]interface{}, len(s.columns))
	if i := m["int"]; i != 0 {
		args[i-1] = &p.Int
	}
	if i := m["text"]; i != 0 {
		args[i-1] = &p.Text
	}
	if i := m["bool"]; i != 0 {
		args[i-1] = &p.Bool
	}
	return args
}
